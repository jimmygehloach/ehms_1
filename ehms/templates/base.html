{% load static i18n %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>{% block title %}{% if title %}{{ title }}{% endif %}{% endblock title %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="electronic health management system">
    <meta name="author" content="Jimmy Gehloach">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script nonce="{{ request.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

    <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}">
    <!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ CSS -->
    {% block css %}
        <!-- Latest compiled and minified Bootstrap CSS -->
        {#  <link nonce="{{ request.csp_nonce }}" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"> #}
        <link nonce="{{ request.csp_nonce }}" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

        <link nonce="{{ request.csp_nonce }}" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">

        {# Google fonts #}
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link nonce="{{ request.csp_nonce }}" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
        <link nonce="{{ request.csp_nonce }}" href="https://fonts.googleapis.com/css2?family=Joan&display=swap" rel="stylesheet">

        {# Google icons #}
        <link nonce="{{ request.csp_nonce }}" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@48,400,0,0" />

        <!-- Your stuff: Third-party CSS libraries go here -->
        <link nonce="{{ request.csp_nonce }}" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

        <!-- This file stores project-specific CSS -->
        <link nonce="{{ request.csp_nonce }}" href="{% static 'css/project.css' %}" rel="stylesheet">

        <link nonce="{{ request.csp_nonce }}" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <link nonce="{{ request.csp_nonce }}" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link nonce="{{ request.csp_nonce }}"  href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet">
    {% endblock css %}

    <!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ Javascript -->
    {% block javascript %}
        <!-- Bootstrap JS and its dependencies-->
        <script nonce="{{ request.csp_nonce }}" src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

{#      <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>#}

        <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

        <script nonce="{{ request.csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/validator/13.6.0/validator.min.js" integrity="sha512-xYHcfaQeUiKHs9YsHqjpyLaHnh+q7y8kYuOGdh5FkJeK7Z+dZct7Yoa7h+PtsrKRh03t8eJZuSeCN7b0dkrFwA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <!-- Your stuff: Third-party javascript libraries go here -->
        <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

        <!-- Project specific Javascript in this file -->
        <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/project.js' %}"></script>

        <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/form-validation.js' %}"></script>
        <script nonce="{{ request.csp_nonce }}" defer src="{% static 'js/checkbox.js' %}"></script>

        <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script nonce="{{ request.csp_nonce }}" src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    {% endblock javascript %}
    {% block head_content %}{% endblock head_content %}
</head>
<body>
{% if request.user.is_authenticated and request.yahoooo == True %}
    <main class="d-flex">
        <aside class="sticky-top" id="main-sticky-sidebar">
            <div class="logo pb-40">
                <a class="d-flex navbar-brand align-items-center" href="/">
                    <strong>EHMS</strong>
                    {% if request.group_name == "country level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Country
                    {% elif request.group_name == "region level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Region
                    {% elif request.group_name == "district level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>District
                    {% elif request.group_name == "hospital level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Hospital
                    {% elif request.group_name == "practitioner level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Practitioner
                    {% elif request.group_name == "nurse level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Nurse
                    {% elif request.group_name == "reception level" %}
                         <i class="ri-arrow-right-s-line ri-lg"></i>Reception
                    {% endif %}
                </a>
            </div>
            {% include 'partials/main-sidebar.html' with title=title %}
        </aside>
        <div class="flex-grow-1">
            <navbar class="d-flex align-items-center sticky-top" id="main-sticky-navbar">
                <div class="menu pr-40">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="ri-menu-line ri-xl"></i></a>
                        </li>
                    </ul>
                </div>
                <div class="main-search-bar flex-grow-1">
                    <form class="d-flex" method="GET" action="{% url 'patients:search' %}" id="main-search-form">
                        <input class="form-control" name="search" type="text" placeholder="Search the patient by uid or name" aria-label="Search" autocomplete="off">
                        <button class="btn search-btn" type="submit">
                            <i class="ri-search-line ri-lg"></i>
                        </button>
                    </form>
                </div>
                <div class="main-profile-link">
                    <ul>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if request.user.image %}
                                <img width="40px" height="40px" src="{{ request.user.image_thumbnail.url }}" alt="{{ request.user.get_full_name }}">
                            {% else %}
                                <i class="ri-user-4-line ri-xl"></i>
                            {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <li>
                                    <a class="dropdown-item" title="Logout" href="{% url 'logout' %}"><i class="ri-logout-box-line"></i> Logout</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </navbar>
            {#  {% include 'partials/main-navbar.html' %}#}
            <div id="main-content">
                <div class="d-flex">
                    <div class="flex-grow-1" id="main-content-wrapper">
                         <div class="container-fluid content-body">
                            <div class="row content-body-inner">
                                {% block content %}{% endblock content %}
                            </div>
                        </div>
                    </div>
                    <div id="id-main-page-sidebar" class="main-page-sidebar" style="margin-left:40px; max-width:300px;min-width:300px;height:80vh;overflow: auto">
                        <div class="container-fluid" id="main-page-sidebar-content">
                            <div class="row">
                                <div class="col-12">
                                    <div class="widget-area">
                                        <h4>Widget Area</h4>
                                        <p>The widgets are going to be place here specific to each page where we can highlight or display key information contain in the page. Each page got their own widgets.</p>
                                    </div>
                                </div>
                                {% block sidebar-content %} {% endblock sidebar-content %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                {% block footer %}{% endblock %}
            </div>
        </div>
    </main>
{% else %}
    <div class="open-base">
        {# Messages aka toast #}
        <div class="container-fluid">
            {% block open %}{% endblock open %}
        </div>
    </div>

{% endif %}

{% include 'partials/toast.html' with messages=messages %}

{% block modal %}{% endblock modal %}
    {% if request.user.is_authenticated and request.yahoooo == True %}
    <script nonce="{{ request.csp_nonce }}" type="application/javascript">

        (function()
        {
            let mainContentWrapper = document.getElementById("main-content-wrapper") || "";
            let mainSidebar = document.getElementById("id-main-page-sidebar") || "";
            let sticky = mainSidebar.offsetTop-100;

            window.onscroll = function ()
            {
                myFunction()
            };

            function myFunction()
            {
                if (window.scrollY > sticky)
                {
                    mainSidebar.classList.add("sticky");
                    mainContentWrapper.classList.add("add-right-margin");
                }
                else
                {
                    mainSidebar.classList.remove("sticky");
                    mainContentWrapper.classList.remove("add-right-margin");
                }
            }
        })();

        // TODO: Move the necessary code into their file
        $('.close-common-toast').on('click', function (e) {
            e.stopPropagation();
            $(this).closest('.common-toast-wrapper').remove();
        })

        $(function() {
            let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        })

        $(function() {
            let vtInlineDropdownWrapper = $('.vt-inline-dropdown-wrapper');
            let vtInlineDropdown = $('.vt-inline-dropdown');

            vtInlineDropdownWrapper.find('.dropdown-arrow-down').show();
            vtInlineDropdownWrapper.find('.dropdown-arrow-straight').hide();
            vtInlineDropdown.hide();
            vtInlineDropdown.attr('data-status', 'collapsed');

            vtInlineDropdown.find('a').on('click', function (e) {
                e.stopPropagation();
            })

            vtInlineDropdownWrapper.on('click', function (e) {
                e.stopPropagation();

                let _this = $(this);

                _this.find('.vt-inline-dropdown').slideToggle(100, function () {
                    let __this = $(this);
                    let id = _this.find('h5').text().trim();

                    if (__this.data('status') === 'collapsed') {
                        __this.data('status', 'open');
                        localStorage.setItem('inlineDropdown' + id, 'true');
                    } else if (__this.data('status') === 'open') {
                        __this.data('status', 'collapsed');
                        localStorage.setItem('inlineDropdown' + id, 'false');
                    }
                    _this.find('.dropdown-arrow-down').toggle();
                    _this.find('.dropdown-arrow-straight').toggle();
                });
            })

            vtInlineDropdownWrapper.each(function () {
                let _this = $(this);
                let id = _this.find('h5').text().trim();
                let item = 'inlineDropdown' + id;
                let dropdown = _this.find('.vt-inline-dropdown');

                if (localStorage.getItem(item) === null) {
                    localStorage.setItem(item, 'false');
                    dropdown.data('status', 'collapsed');
                    _this.find('.dropdown-arrow-down').show();
                    _this.find('.dropdown-arrow-straight').hide();
                } else if (localStorage.getItem(item) === 'true') {
                    dropdown.show();
                    dropdown.data('status', 'open');
                    _this.find('.dropdown-arrow-down').hide();
                    _this.find('.dropdown-arrow-straight').show();
                } else if (localStorage.getItem(item) === 'false') {
                    dropdown.hide();
                    _this.find('.dropdown-arrow-down').show();
                    _this.find('.dropdown-arrow-straight').hide();
                    dropdown.data('status', 'collapsed');
                }
            });
        });

        {#TODO: implement it later #}
        $('.dropdown-button').on('click', function(e) {
            e.stopPropagation();
            let _this = $(this);
            console.log(_this.attr('aria-expanded'))
            if ( _this.attr('aria-expanded') == 'false' ) {

                _this.addClass('dropdown-button-expand-view')
            } else {
                _this.removeClass('dropdown-button-expand-view')
            }
        // })
        });

        class AddressFormFields {
            // Jquery Dependant class
            #formId = null;
            #regionUrl = null;
            #districtUrl = null;
            #townUrl = null;
            #postcodeUrl = null;

            #form = null;
            #country = null;
            #region = null;
            #district = null;
            #town = null;
            #postcode = null;

            #countryId = null;
            #regionId = null;
            #districtId = null;
            #townId = null;
            #postcodeId = null;

            #countryDataObj = {};
            #regionDataObj = {};
            #districtDataObj = {};
            #townDataObj = {};
            #events = 'change';

            constructor( obj ) {
                this.#formId = obj.formId ??= null;
                this.#regionUrl = obj.regionUrl ??= null;
                this.#districtUrl = obj.districtUrl ??= null;
                this.#townUrl = obj.townUrl ??= null;
                this.#postcodeUrl = obj.postcodeUrl ??= null;
                this.#events = obj.events ??= this.#events;

                if ( this.#initialCheck() ) {
                    this.#fetchFieldElements();
                    this.#fireTheEvents();
                } else {
                    return false;
                }
            }

            #initialCheck() {
                // check the required arguments
                return !(this.#formId === false
                    || this.#regionUrl === false
                    || this.#districtUrl === false
                    || this.#townUrl === false
                    || this.#postcodeUrl === false);
            }

            #fetchFieldElements() {
                this.#form = $('#' + this.#formId);

                this.#country = this.#form.find('select[name="country"]');
                this.#countryId = this.#country.val();

                this.#region = this.#form.find('select[name=region]');
                this.#regionId = this.#region.val();

                this.#district = this.#form.find('select[name=district]');
                this.#districtId = this.#district.val();

                this.#town = this.#form.find('select[name=town]');
                this.#townId = this.#town.val();

                this.#postcode = this.#form.find('select[name=postcode]');
                this.#postcodeId = this.#postcode.val();

                this.#setDataObj();
            }

            #setDataObj() {
                this.#countryDataObj = {
                    'country_id': this.#countryId
                }

                this.#regionDataObj = {
                    'country_id': this.#countryId,
                    'region_id': this.#regionId,
                }

                this.#districtDataObj = {
                    'country_id': this.#countryId,
                    'region_id': this.#regionId,
                    'district_id': this.#districtId,
                }

                this.#townDataObj = {
                    'country_id': this.#countryId,
                    'region_id': this.#regionId,
                    'district_id': this.#districtId,
                    'town_id': this.#townId,
                }
            }

            #fireTheEvents() {
                this.#country.on(this.#events, () => {
                    this.#fetchFieldElements();
                    this.#region.html('');
                    this.#district.html('');
                    this.#town.html('');
                    this.#postcode.html('');

                    this.#fillTheAddress({
                        URL: this.#regionUrl,
                        target: this.#region,
                        data: this.#countryDataObj,
                    })
                })

                this.#region.on(this.#events, () => {
                    this.#fetchFieldElements();
                    this.#district.html('');
                    this.#town.html('');
                    this.#postcode.html('');

                    // check parent elements
                    this.#fillTheAddress({
                        URL: this.#districtUrl,
                        target: this.#district,
                        data: this.#regionDataObj,
                    })
                })

                this.#district.on(this.#events, () => {
                    this.#fetchFieldElements();
                    this.#town.html('');
                    this.#postcode.html('');

                    this.#fillTheAddress({
                        URL: this.#townUrl,
                        target: this.#town,
                        data: this.#districtDataObj,
                    })
                })

                this.#town.on(this.#events, () => {
                    this.#fetchFieldElements();
                    this.#postcode.html('');

                    this.#fillTheAddress({
                        URL: this.#postcodeUrl,
                        target: this.#postcode,
                        data: this.#townDataObj,
                    })
                })
            }

            #fillTheAddress( obj ) {
                let URL = obj.URL ??= null;
                let target = obj.target ??= null;
                let dataObj = obj.data ??= null;

                $.ajax({
                    url: URL,
                    cache: 'false',
                    dataType: 'json',
                    type: 'POST',
                    data: dataObj,
                    beforeSend: function (xhr) {
                        target.html('<option value="">Loading ...</option>');
                        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
                    },
                }).done(function (data) {
                   // change the target options with the
                    // fetched data from the server
                    let htmlCode;
                    htmlCode += '<option value="" selected>Choose your option</option>';
                    $.each(data, function (index, value) {
                        htmlCode += '<option value="' +  value.id  + '">' + value.name + '</option>';
                    });
                    target.html(htmlCode);
                }).fail(function (e) {
                    // on fail show helping message
                    let htmlCode;
                    if ( e === 400 ) {
                        htmlCode = '<option value="" hidden>Bad request. Check your parameters.</option>';
                    } else if (e === 404) {
                        htmlCode = '<option value="" hidden>Nothing found. Try other options if available.</option>';
                    } else {
                        htmlCode = '<option value="" hidden>Something went wrong. Try again.</option>';
                    }
                    target.html(htmlCode);
                });
            }
        }

    </script>
    {% endif %}
    {% block inline_javascript %}{% endblock inline_javascript %}
</body>
</html>
